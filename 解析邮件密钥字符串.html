<style>
  body {
    background-color: #8aba87;
    overflow: hidden;
  }

  * {
    margin: 0;
    outline: 0;
    padding: 0;
  }

  header {
    display: flex;
  }

  header {
    display: grid;
    grid-template-columns: repeat(10, 1fr);
  }

  header>div:nth-child(3) {
    grid-column: 10;
  }

  #emailSendPage div {
    margin: 10px;
    padding: 10px;
  }
</style>

<div id='emailSendPage'>
  <header>
    <div id="SearchA">生成密钥</div>
    <div id="SearchB">解析密钥</div>
    <div>Logout</div>
  </header>

</div>
<script src="https://cdn.staticfile.org/jquery/1.10.2/jquery.min.js"></script>

<script>
  $(function () {

    let ts1 = [-64, 18, 65, -98, 95, 105, 80, 8, 106, 78, -81, 94, -56, -115, 27, -108, 67, 3, 57, 97, 72, -78, 90, 19, -79, -55, 26, -93, -109, -104, 16, -96]
    let ts2 = [192, 18, 65, 158, 95, 105, 80, 8, 106, 78, 175, 94, 200, 141, 27, 148, 67, 3, 57, 97, 72, 178, 90, 19, 177, 201, 26, 163, 147, 152, 16, 160]
    console.log('ts1',ts1.length)
    console.log('ts2',ts2.length)
    console.log(tobase64(ts2,'reset'))
    
    let str = `
    <span style='display:none' id='newconfidantkeyMzQ1NjMyODI4QHFxLmNvbQ==&&Cgguqfmkj4+0wCN+5GN1D3ygLILCd8IL0O/8mtNzaVKHC2TDV3bCdeafUQLwZX9V4w0VgZ7VGU0j8ZMVChIC1QOtlU6RLOpC+WYkjM0prYc=##a3Vhbmd6aWh1aUAxNjMuY29t&&Rc9Qfsx3DbKwlOM0a6HjjfqF8+Kz29pTLFo+EWqZIW2pY/Sq6YIytH06OureHb67VSwi+qJBJ0hHVqtNGTxxe5eDJqdL/XHXMWIyg+eYLU4='></span>
    <span style='display:none' id='newconfidantuserid36C6B7A37844EC79C62CCC8D4D265C41712BB2F21A1370897B9C5D35AE3D7B4E35609D93FCF4'></span>
    <div myconfidantbegin=''>
      <br /><br /><br /><span>Sent from MyConfidant, the app for encrypted email.</span>
      </div>`

      let strid = $(str).attr('id')
      strid.replace('')
      console.log('str',strid)

    function getNewconfidantkeyid(str) {
      let len
      if (str.indexOf('newconfidantkey') === 0) {
        len = 'newconfidantkey'.length
      } else if (str.indexOf('newconfidantuserid') === 0) {
        len = 'newconfidantuserid'.length
      }
      return str.substr(len)
    }

    function splitNewconfidant(str) {
      let arr = str.split('##')
      let arr2 = []
      for (let i in arr) {
        let str = arr[i].split('&&')
        arr2.push({
          name: str[0],
          key: str[1]
        })
      }
      return arr2
    }

    function toNewconfidantkeyString(arr) {
      let str = ''
      return arr.map(function (x) {
        let s = `${x.name}&&${x.key}`
        if (str === '') {
          str = str + s
        } else {
          str = str + '##' + s
        }
        return str
      })
    }

    function toNewconfidantObj(str) {

      let $str = $(`<div>${str}</div>`)
      let span = $str.find('span')

      let id1 = span.eq(0).attr('id')
      let id2 = span.eq(1).attr('id')

      let newconfidantkey = getNewconfidantkeyid(id1)
      let newconfidantuserid = getNewconfidantkeyid(id2)

      let splitNew = splitNewconfidant(newconfidantkey)

      return {
        newconfidantkey,
        newconfidantuserid,
        emailName: splitNew
      }
    }

    function toNewconfidantHtml(text, key, uid) {

      /* 返回加密后的html
      *
      * @param  {text}       
      * @param  {key} 
      * @param  {uid} 
      * @return {html}           
      */
      let html = `${text}
    <span style='display:none' id='newconfidantkey${key}'></span>
    <span style='display:none' id='newconfidantuserid${uid}'></span>
    <div myconfidantbegin=''><br /><br /><br /><span>Sent from MyConfidant, the app for encrypted email.</span></div>`
      return html
    }

    $('#SearchB').click(function () {
      // 解析密钥
      let $str = $(`<div>${str}</div>`)
      let span = $str.find('span')

      let id1 = span.eq(0).attr('id')
      let id2 = span.eq(1).attr('id')
      let obj = {
        newconfidantkey: getNewconfidantkeyid(id1),
        newconfidantuserid: getNewconfidantkeyid(id2),
      }
      console.log(obj)
      let arr = splitNewconfidant(obj.newconfidantkey)
      console.log(arr)
      console.log(toNewconfidantkeyString(str))


    })

    $('#SearchA').click(function () {
      //生成密钥
      let newconfidantText = '4x2fHgATrmWCiL9soNsJ9XnsGwEkfA5DKzHIwBU3d6HkbDgCQSpnaOIYILMAhwZU8Ex620Wr/6GyWudTaXwKmg=='
      let newconfidantkey = 'MzQ1NjMyODI4QHFxLmNvbQ==&&Cgguqfmkj4+0wCN+5GN1D3ygLILCd8IL0O/8mtNzaVKHC2TDV3bCdeafUQLwZX9V4w0VgZ7VGU0j8ZMVChIC1QOtlU6RLOpC+WYkjM0prYc=##a3Vhbmd6aWh1aUAxNjMuY29t&&Rc9Qfsx3DbKwlOM0a6HjjfqF8+Kz29pTLFo+EWqZIW2pY/Sq6YIytH06OureHb67VSwi+qJBJ0hHVqtNGTxxe5eDJqdL/XHXMWIyg+eYLU4='
      let newconfidantuserid = '36C6B7A37844EC79C62CCC8D4D265C41712BB2F21A1370897B9C5D35AE3D7B4E35609D93FCF4'
      let html = `${newconfidantText}
    <span style='display:none' id='newconfidantkey${newconfidantkey}'></span>
    <span style='display:none' id='newconfidantuserid${newconfidantuserid}'></span>
    <div myconfidantbegin=''><br /><br /><br /><span>Sent from MyConfidant, the app for encrypted email.</span></div>`
      console.log(html)





    })
  });


  function tobase64(d, k) {
    let type = Object.prototype.toString.call(d)
    let arr = []
    if (type == '[object Number]') {
        d = d + ''
    }
    if (k == 'string') {
        arr = Buffer.from(d, 'hex')
        return arr
    }
    if (k == 'reset') {
        //在有node 环境中替换为下一行的内容 
        //let arr = new Uint8Array(Buffer.from(d, 'base64'))
        let arr = d
        let arr2 = []
        console.log('tobase64 reset', arr)
        for (let i in arr) {
            if (arr[i] > 128) {
               arr2.push(arr[i] -256)
            } else {
                arr2.push(arr[i])
            }
        }
        console.log('tobase64 reset', arr2)

        return arr2
    }

    arr = Buffer.from(d, 'hex').toString("base64");
    return arr
}

</script>